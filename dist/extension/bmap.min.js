
/*
* Licensed to the Apache Software Foundation (ASF) under one
* or more contributor license agreements.  See the NOTICE file
* distributed with this work for additional information
* regarding copyright ownership.  The ASF licenses this file
* to you under the Apache License, Version 2.0 (the
* "License"); you may not use this file except in compliance
* with the License.  You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing,
* software distributed under the License is distributed on an
* "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
* KIND, either express or implied.  See the License for the
* specific language governing permissions and limitations
* under the License.
*/


!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("echarts")):"function"==typeof define&&define.amd?define(["exports","echarts"],t):t(e.bmap={},e.echarts)}(this,function(e,y){"use strict";function g(e,t){this._bmap=e,this.dimensions=["lng","lat"],this._mapOffset=[0,0],this._api=t,this._projection=new BMap.MercatorProjection}function o(a,r){return r=r||[0,0],y.util.map([0,1],function(e){var t=r[e],o=a[e]/2,n=[],i=[];return n[e]=t-o,i[e]=t+o,n[1-e]=i[1-e]=r[1-e],Math.abs(this.dataToPoint(n)[e]-this.dataToPoint(i)[e])},this)}var v;function _(e){for(var t in e)if(e.hasOwnProperty(t))return;return 1}g.prototype.dimensions=["lng","lat"],g.prototype.setZoom=function(e){this._zoom=e},g.prototype.setCenter=function(e){this._center=this._projection.lngLatToPoint(new BMap.Point(e[0],e[1]))},g.prototype.setMapOffset=function(e){this._mapOffset=e},g.prototype.getBMap=function(){return this._bmap},g.prototype.dataToPoint=function(e){var t=new BMap.Point(e[0],e[1]),o=this._bmap.pointToOverlayPixel(t),n=this._mapOffset;return[o.x-n[0],o.y-n[1]]},g.prototype.pointToData=function(e){var t=this._mapOffset;return[(e=this._bmap.overlayPixelToPoint({x:e[0]+t[0],y:e[1]+t[1]})).lng,e.lat]},g.prototype.getViewRect=function(){var e=this._api;return new y.graphic.BoundingRect(0,0,e.getWidth(),e.getHeight())},g.prototype.getRoamTransform=function(){return y.matrix.create()},g.prototype.prepareCustoms=function(e){var t=this.getViewRect();return{coordSys:{type:"bmap",x:t.x,y:t.y,width:t.width,height:t.height},api:{coord:y.util.bind(this.dataToPoint,this),size:y.util.bind(o,this)}}},g.dimensions=g.prototype.dimensions,g.create=function(e,f){var h,u=f.getDom();e.eachComponent("bmap",function(e){var t,o,n,i=f.getZr().painter,a=i.getViewportRoot();if("undefined"==typeof BMap)throw new Error("BMap api is not loaded");function r(e){this._root=e}if(v=v||((r.prototype=new BMap.Overlay).initialize=function(e){return e.getPanes().labelPane.appendChild(this._root),this._root},r.prototype.draw=function(){},r),h)throw new Error("Only one bmap component can exist");e.__bmap||((t=u.querySelector(".ec-extension-bmap"))&&(a.style.left="0px",a.style.top="0px",u.removeChild(t)),(t=document.createElement("div")).style.cssText="width:100%;height:100%",t.classList.add("ec-extension-bmap"),u.appendChild(t),delete(o=e.get("mapOptions")||{}).mapType,d=e.__bmap=new BMap.Map(t,o),n=new v(a),d.addOverlay(n),i.getViewportRootOffset=function(){return{offsetLeft:0,offsetTop:0}});var p,s,m,d=e.__bmap,l=e.get("center"),c=e.get("zoom");l&&c&&(p=d.getCenter(),s=d.getZoom(),e.centerOrZoomChanged([p.lng,p.lat],s)&&(m=new BMap.Point(l[0],l[1]),d.centerAndZoom(m,c))),(h=new g(d,f)).setMapOffset(e.__mapOffset||[0,0]),h.setZoom(c),h.setCenter(l),e.coordinateSystem=h}),e.eachSeries(function(e){"bmap"===e.get("coordinateSystem")&&(e.coordinateSystem=h)})},y.extendComponentModel({type:"bmap",getBMap:function(){return this.__bmap},setCenterAndZoom:function(e,t){this.option.center=e,this.option.zoom=t},centerOrZoomChanged:function(e,t){var o,n,i=this.option;return o=e,n=i.center,!(o&&n&&o[0]===n[0]&&o[1]===n[1]&&t===i.zoom)},defaultOption:{center:[104.114129,37.550339],zoom:5,mapStyle:{},mapStyleV2:{},mapOptions:{},roam:!1}}),y.extendComponentView({type:"bmap",render:function(i,e,a){function t(e,t){var o,n;r||(o=p.parentNode.parentNode.parentNode,n=[-parseInt(o.style.left,10)||0,-parseInt(o.style.top,10)||0],p.style.left=n[0]+"px",p.style.top=n[1]+"px",s.setMapOffset(n),i.__mapOffset=n,a.dispatchAction({type:"bmapRoam"}))}var r=!0,o=i.getBMap(),p=a.getZr().painter.getViewportRoot(),s=i.coordinateSystem;function n(){r||a.dispatchAction({type:"bmapRoam"})}o.removeEventListener("moving",this._oldMoveHandler),o.removeEventListener("moveend",this._oldMoveHandler),o.removeEventListener("zoomend",this._oldZoomEndHandler),o.addEventListener("moving",t),o.addEventListener("moveend",t),o.addEventListener("zoomend",n),this._oldMoveHandler=t,this._oldZoomEndHandler=n;var m=i.get("roam");m&&"scale"!==m?o.enableDragging():o.disableDragging(),m&&"move"!==m?(o.enableScrollWheelZoom(),o.enableDoubleClickZoom(),o.enablePinchToZoom()):(o.disableScrollWheelZoom(),o.disableDoubleClickZoom(),o.disablePinchToZoom());var d=i.__mapStyle,l=i.get("mapStyle")||{},c=JSON.stringify(l);JSON.stringify(d)!==c&&(_(h)||o.setMapStyle(y.util.clone(l)),i.__mapStyle=JSON.parse(c));var f=i.__mapStyle2,h=i.get("mapStyleV2")||{},u=JSON.stringify(h);JSON.stringify(f)!==u&&(_(h)||o.setMapStyleV2(y.util.clone(h)),i.__mapStyle2=JSON.parse(u)),r=!1}}),y.registerCoordinateSystem("bmap",g),y.registerAction({type:"bmapRoam",event:"bmapRoam",update:"updateLayout"},function(e,t){t.eachComponent("bmap",function(e){var t=e.getBMap(),o=t.getCenter();e.setCenterAndZoom([o.lng,o.lat],t.getZoom())})});e.version="1.0.0"});
